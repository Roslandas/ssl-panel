#!/bin/bash

clear
# Patikrinam ar vartotojas root
if [ "$EUID" -ne 0 ]; then
  echo ""
  echo "âŒ Paleisk Å¡Ä¯ skriptÄ… kaip root!"
  exit 1
fi

clear
# PapraÅ¡ome vartotojo Ä¯vesti domenÄ…
echo ""
read -rp "ğŸŒ Ä®veskite savo domenÄ… (pvz. example.com): " domain

clear
# Patikrinam ar domenas Ä¯vestas
if [ -z "$domain" ]; then
  echo ""
  echo "âŒ Domenas neÄ¯vestas. Nutraukiama."
  rm -rf ssl-generator-panel
  exit 1
fi

clear
echo ""
echo "ğŸ”§ Ä®diegiame socat..."
apt update && apt install socat curl -y

clear
echo ""
echo "ğŸ“¥ Ä®diegiame acme.sh..."
curl https://get.acme.sh | sh

clear
echo ""
echo "âš™ï¸ Nustatome Let's Encrypt kaip numatytÄ… CA..."
~/.acme.sh/acme.sh --set-default-ca --server letsencrypt

clear
echo ""
echo "âœ‰ï¸ Registruojame paskyrÄ…..."
~/.acme.sh/acme.sh --register-account -m rolka@gmail.com

clear
# Sustabdome servisÄ…, jei kas nors naudoja portÄ… 80
PORT80_PID=$(lsof -ti:80)
if [ -n "$PORT80_PID" ]; then
  SERVICE=$(ps -p $PORT80_PID -o comm=)
  echo ""
  echo "ğŸ”§ Sustabdome $SERVICE, kad atlaisvintume portÄ… 80..."
  systemctl stop $SERVICE
fi

clear
echo ""
echo "ğŸ” IÅ¡duodame sertifikatÄ… domenui: $domain"
~/.acme.sh/acme.sh --issue -d "$domain" --standalone

clear
echo ""
echo "ğŸ“¦ Ä®raÅ¡ome sertifikatÄ… Ä¯ /root/"
~/.acme.sh/acme.sh --install-cert -d "$domain" \
  --key-file /root/private.key \
  --fullchain-file /root/cert.crt

clear
# Jei sustabdÄ—me servisÄ…, vÄ—l jÄ¯ paleidÅ¾iame
if [ -n "$PORT80_PID" ]; then
  echo ""
  echo "ğŸ”§ PaleidÅ¾iame $SERVICE..."
  systemctl start $SERVICE
fi

rm -rf ssl-generator-panel
clear
echo ""
echo "âœ… Sertifikatas sÄ—kmingai sugeneruotas domenui: $domain"

